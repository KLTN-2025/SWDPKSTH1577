{% extends 'core/base.html' %}
{% load static %}

{% block main_content %}
<nav aria-label="breadcrumb" class="container mt-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'home' %}">Trang chủ</a></li>
        <li class="breadcrumb-item"><a href="{% url 'room_search' %}">Danh sách phòng</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ room.ten_p }}</li>
    </ol>
</nav>

<section class="py-3">
    <div class="container">
        <div class="row">
            
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm mb-4">
                    <img src="{{ room.anh_dai_dien.url }}" class="card-img-top " alt="{{ room.ten_p }}" style="height: 400px; object-fit: cover; border-radius: 20px;">
                    
                    <div class="card-body">
                        <h1 class="h3 fw-bold">{{ room.ten_p }}</h1>
                        <p class="text-muted mb-3">{{ room.get_loai_p_display }}</p>
                        
                        <h5 class="mt-4">Về phòng này</h5>
                        <p class="card-text">{{ room.mo_ta }}</p>
                        
                        
                    </div>
                </div>
            </div>
            
            
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm sticky-top" style="top: 20px;">
                    <div class="card-body">
                        
                        <div class="row g-2 mb-4">
                            <div class="col-12 mb-2">
                                <img src="{% static 'images/p1.png' %}" class="img-fluid " alt="Phòng view biển" style="height: 185px; width: 100%; object-fit: cover; border-radius: 20px;">
                            </div>
                            <div class="col-12 mb-2">
                                <img src="{% static 'images/p2.jpg' %}" class="img-fluid " alt="Phòng view thành phố" style="height: 185px; width: 100%; object-fit: cover; border-radius: 20px;">
                            </div>
                        </div>
                        
                        <h4 class="text-center mb-4">Booking</h4>
                        <h3 class="text-primary text-center mb-4">{{ room.gia|floatformat:0 }} VND/ngày</h3>
                        
                        <button class="btn btn-primary w-100 py-2" data-bs-toggle="modal" data-bs-target="#bookingModal">
                            Đặt phòng ngay
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>


<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookingModalLabel">
                    <span class="badge bg-primary rounded-circle me-2">1</span>
                    Thông tin lưu trú
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'room_detail' room.ma_p %}">
                {% csrf_token %}
                <input type="hidden" name="step" value="1">
                
                <div class="modal-body">
                    <div class="row">
                        
                        <div class="col-md-6">
                            <img src="{{ room.anh_dai_dien.url }}" class="img-fluid  mb-3" alt="{{ room.ten_p }}" style="border-radius: 20px;">
                            <h5>{{ room.ten_p }}</h5>
                            <p class="text-muted">{{ room.get_loai_p_display }}</p>
                        </div>
                        
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Ngày nhận phòng</label>
                                <input type="date" name="check_in" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Ngày trả phòng</label>
                                <input type="date" name="check_out" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Số người</label>
                                <select name="guests" class="form-select" required>
                                    {% for i in room.guest_range %}
                                    <option value="{{ i }}">{{ i }} người</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="alert alert-info mt-4">
                                <h6>Bạn sẽ trả: <span id="totalPrice" class="fw-bold">0 VND</span></h6>
                                <p class="mb-0">Cho <span id="totalNights">0</span> ngày</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="nextStep()">Kế tiếp</button>
                </div>
            </form>
        </div>
    </div>
</div>


<div class="modal fade" id="customerInfoModal" tabindex="-1" aria-labelledby="customerInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customerInfoModalLabel">
                    <span class="badge bg-primary rounded-circle me-2">2</span>
                    Thông tin khách hàng
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'room_detail' room.ma_p %}">
                {% csrf_token %}
                <input type="hidden" name="step" value="2">
                <input type="hidden" name="check_in" id="finalCheckIn">
                <input type="hidden" name="check_out" id="finalCheckOut">
                <input type="hidden" name="guests" id="finalGuests">
                
                <div class="modal-body">
                    <div class="row">
                        
                        <div class="col-md-6">
                            <img src="{{ room.anh_dai_dien.url }}" class="img-fluid  mb-3" alt="{{ room.ten_p }}" style="border-radius: 20px;">
                            <h5>{{ room.ten_p }}</h5>
                            <p class="text-muted">{{ room.get_loai_p_display }}</p>
                        </div>
                        
                        
                        <div class="col-md-6">
                            {% if user.is_authenticated and user.khachhang %}

                            <div class="mb-3">
                                <label class="form-label">Tên khách hàng</label>
                                <input type="text" class="form-control" value="{{ user.khachhang.ten_kh }}" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" value="{{ user.email }}" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Số điện thoại</label>
                                <input type="tel" class="form-control" value="{{ user.khachhang.sdt }}" readonly>
                            </div>
                            {% else %}
                            <div class="alert alert-warning">
                                Vui lòng <a href="{% url 'login' %}">đăng nhập</a> để đặt phòng
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" onclick="prevStep()">Quay lại</button>
    {% if user.is_authenticated and user.khachhang %}
        <div id="paypal-button-container"></div>
    {% else %}
        <div class="alert alert-warning">
            Vui lòng <a href="{% url 'login' %}">đăng nhập</a> để đặt phòng
        </div>
    {% endif %}
                </div>
            </form>
        </div>
    </div>
</div>


<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="successModalLabel">CrownePlaza</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center py-4">
                <i class="fas fa-check-circle text-success display-4 mb-3"></i>
                <h4>Đã đặt phòng thành công!</h4>
                <p>Chào mừng bạn đến với CrownePlaza.</p>
                <div class="progress mt-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" id="redirectProgress" style="width: 0%"></div>
                </div>
                <p class="small text-muted mt-2">Tự động chuyển hướng sau <span id="countdown">20</span> giây...</p>
            </div>
            <div class="modal-footer justify-content-center">
                <a href="#" id="bookingDetailLink" class="btn btn-primary">Chi tiết đơn đặt phòng</a>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://www.paypal.com/sdk/js?client-id=AUbh_JXsTbSU-qKuw2cR5TMVzTdMcFwFkEg9dTHEApigqGwaBFz1K19mmAMr9GWo-XA7P3sbfphMZZDo&currency=USD"></script>

<script>

function calculateTotal() {
    const checkIn = document.querySelector('input[name="check_in"]');
    const checkOut = document.querySelector('input[name="check_out"]');
    const pricePerNight = parseFloat("{{ room.gia }}");
    
    if (checkIn.value && checkOut.value) {
        const dateIn = new Date(checkIn.value);
        const dateOut = new Date(checkOut.value);
        const nights = Math.ceil((dateOut - dateIn) / (86400000)); 
        
        if (nights > 0) {
            const totalPrice = nights * pricePerNight;
            document.getElementById('totalNights').textContent = nights;
            document.getElementById('totalPrice').textContent = 
                totalPrice.toLocaleString('vi-VN') + ' VND';
            return;
        }
    }
    
    document.getElementById('totalNights').textContent = '0';
    document.getElementById('totalPrice').textContent = '0 VND';
}

function validateDates() {
    const checkIn = document.querySelector('input[name="check_in"]');
    const checkOut = document.querySelector('input[name="check_out"]');
    
    if (!checkIn.value || !checkOut.value) {
        alert('Vui lòng chọn đầy đủ ngày nhận và ngày trả phòng');
        return false;
    }
    
    const dateIn = new Date(checkIn.value);
    const dateOut = new Date(checkOut.value);
    
    if (dateOut <= dateIn) {
        alert('Ngày trả phòng phải sau ngày nhận phòng');
        return false;
    }
    
    return true;
}


function renderPaypalButton() {
    const roomPrice = parseFloat("{{ room.gia }}");
    const nights = Math.ceil((new Date(document.getElementById('finalCheckOut').value) - new Date(document.getElementById('finalCheckIn').value)) / (86400000));
    const totalVND = nights * roomPrice;
    const exchangeRate = 26000;
    const totalUSD = (totalVND / exchangeRate).toFixed(2);

    const tempBookingData = JSON.parse(localStorage.getItem('temp_booking_data'));
    if (!tempBookingData) {
        alert('Lỗi: Không tìm thấy dữ liệu đặt phòng. Vui lòng thử lại.');
        return;
    }


    paypal.Buttons({
        createOrder: function(data, actions) {
            // Gửi dữ liệu đặt phòng cùng với request tạo đơn hàng
            return fetch('{% url "create_paypal_order" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(tempBookingData) // Gửi dữ liệu đặt phòng
            }).then(response => {
                if (!response.ok) {
                    return response.json().then(error => {
                        throw new Error(error.message);
                    });
                }
                return response.json();
            }).then(order => {
                // Kiểm tra orderID hợp lệ trước khi trả về
                if (!order || !order.orderID) {
                    throw new Error('Không nhận được Order ID từ PayPal.');
                }
                return order.orderID;
            }).catch(error => {
                console.error('Lỗi khi tạo đơn hàng PayPal:', error);
                alert('Lỗi: ' + error.message);
            });
        },
        onApprove: function(data, actions) {
            // Sau khi người dùng chấp thuận, gọi API backend để xác thực
            return fetch('{% url "capture_paypal_order" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ orderID: data.orderID })
            }).then(response => response.json())
              .then(data => {
                if (data.status === 'success') {
                    // Hiển thị modal thành công và chuyển hướng
                    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                    document.getElementById('bookingDetailLink').href = data.redirect_url;
                    successModal.show();
                    startCountdown(20, data.redirect_url);
                    $('#customerInfoModal').modal('hide');
                } else {
                    throw new Error(data.message || 'Thanh toán không thành công');
                }
            }).catch(error => {
                console.error('Lỗi khi xử lý thanh toán:', error);
                alert('Thanh toán thất bại. Vui lòng thử lại.');
            });
        }
    }).render('#paypal-button-container');
}




function nextStep() {
    if (!validateDates()) return;
    
    const checkInInput = document.querySelector('input[name="check_in"]');
    const checkOutInput = document.querySelector('input[name="check_out"]');
    
    const bookingData = {
        check_in: checkInInput.value,
        check_out: checkOutInput.value,
        guests: document.querySelector('select[name="guests"]').value,
        room_id: "{{ room.ma_p }}"
    };
    
    const dateIn = new Date(bookingData.check_in);
    const dateOut = new Date(bookingData.check_out);
    const nights = Math.ceil((dateOut - dateIn) / (86400000)); 
    
    if (nights <= 0) {
        alert('Ngày trả phòng phải sau ngày nhận phòng.');
        return;
    }

   
    const roomPrice = parseFloat("{{ room.gia }}");
    const totalVND = nights * roomPrice;
    bookingData.total_vnd = totalVND;

    localStorage.setItem('temp_booking_data', JSON.stringify(bookingData));
    
    const formData = new FormData();
    formData.append('check_in', bookingData.check_in);
    formData.append('check_out', bookingData.check_out);
    formData.append('guests', bookingData.guests);
    formData.append('total_vnd', totalVND); 
    formData.append('step', '1');
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

    fetch("{% url 'room_detail' room.ma_p %}", {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            document.getElementById('finalCheckIn').value = bookingData.check_in;
            document.getElementById('finalCheckOut').value = bookingData.check_out;
            document.getElementById('finalGuests').value = bookingData.guests;
            
            $('#bookingModal').modal('hide');
            $('#customerInfoModal').modal('show');
            
           
            if (totalVND > 0) {
                renderPaypalButton();
            } else {
                alert('Có lỗi xảy ra khi tính tổng tiền. Vui lòng thử lại.');
            }
        } else {
            throw new Error(data.message || 'Lỗi khi lưu thông tin đặt phòng');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Lỗi: ' + error.message);
    });
}



function prevStep() {
    const customerInfoModal = bootstrap.Modal.getInstance(document.getElementById('customerInfoModal'));
    const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
    
    customerInfoModal.hide();
    bookingModal.show();
}

function handleBookingSubmit(e) {
    e.preventDefault();
    
    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = `
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        Đang xử lý...
    `;

     
     const tempBooking = localStorage.getItem('temp_booking_data');
    const formData = new FormData(form);
    
    if (tempBooking) {
        const bookingData = JSON.parse(tempBooking);
        formData.set('check_in', bookingData.check_in);
        formData.set('check_out', bookingData.check_out);
        formData.set('guests', bookingData.guests);
    }
    
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(async response => {
        const data = await response.json();
        if (!response.ok) throw data;
        return data;
    })
    .then(data => {
        if (data.status === 'success') {
            localStorage.removeItem('temp_booking_data');
            
            const successModal = new bootstrap.Modal(document.getElementById('successModal'));
            document.getElementById('bookingDetailLink').href = data.redirect_url;
            successModal.show();
             
        startCountdown(20, data.redirect_url);
        
        
        $('#customerInfoModal').modal('hide');
        } else {
            throw new Error(data.message || 'Lỗi không xác định');
        }
    })
    .catch(error => {
        let errorMsg = 'Lỗi hệ thống';
        if (error.message) errorMsg = error.message;
        
        
        const savedData = localStorage.getItem('temp_booking_data');
        if (savedData && error.message.includes('session')) {
            const {check_in, check_out, guests} = JSON.parse(savedData);
            document.getElementById('finalCheckIn').value = check_in;
            document.getElementById('finalCheckOut').value = check_out;
            document.getElementById('finalGuests').value = guests;
            errorMsg += '. Đã khôi phục thông tin đặt phòng của bạn.';
        }
        
        showErrorModal(errorMsg);
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

function startCountdown(seconds, redirectUrl) {
    let count = seconds;
    const countdownElement = document.getElementById('countdown');
    const progressBar = document.getElementById('redirectProgress');
    
    const timer = setInterval(() => {
        count--;
        countdownElement.textContent = count;
        progressBar.style.width = `${(seconds - count) * (100/seconds)}%`;
        
        if (count <= 0) {
            clearInterval(timer);
            window.location.href = redirectUrl;
        }
    }, 1000);
    
    
    document.getElementById('bookingDetailLink').addEventListener('click', () => {
        clearInterval(timer);
        window.location.href = redirectUrl;
    });
}


document.addEventListener('DOMContentLoaded', function() {
    
    document.querySelector('input[name="check_in"]').addEventListener('change', calculateTotal);
    document.querySelector('input[name="check_out"]').addEventListener('change', calculateTotal);
    
    
    // document.querySelector('#customerInfoModal form').addEventListener('submit', handleBookingSubmit);
    
    $('#customerInfoModal').on('hidden.bs.modal', function () {
        const paypalButtonContainer = document.getElementById('paypal-button-container');
        if (paypalButtonContainer) {
            paypalButtonContainer.innerHTML = '';
        }
    });
    
    {% if booking_success %}
    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
    successModal.show();
    document.getElementById('bookingDetailLink').href = "{% url 'booking_detail' booking_id %}";
    {% endif %}
});
</script>
{% endblock %}